<p-overlaybadge
  [value]="activeFiltersCount > 0 ? activeFiltersCount.toString() : '0'"
  [class.hidden-badge]="activeFiltersCount === 0"
>
  <p-button
    [label]="'filter.label' | translate"
    outlined="true"
    severity="secondary"
    icon="ph-bold ph-funnel"
    iconPos="right"
    (click)="popover.toggle($event)"
    fluid="true"
  />
</p-overlaybadge>

<p-popover #popover appendTo="body" styleClass="filter-popover">
  <div class="w-auto p-4 max-w-150">
    <div class="overflow-x-auto overflow-y-hidden">
      <form [formGroup]="filterForm">
        <div class="flex gap-4 p-3">
          @for (filterConfig of config(); track filterConfig.filter) {
            <div class="flex flex-col gap-1">
              <!-- Header del filtro -->
              <div class="flex items-center gap-2 justify-between h-7">
                <label [attr.for]="'filter-' + filterConfig.filter">
                  {{ filterConfig.label | translate }}
                  @if (getSelectedCount(filterConfig.filter) > 0) {
                    <span>({{ getSelectedCount(filterConfig.filter) }})</span>
                  }
                </label>

                @if (filterConfig.cleanable && getSelectedCount(filterConfig.filter) > 0) {
                  <p-button
                    icon="ph ph-trash-simple"
                    severity="secondary"
                    variant="text"
                    styleClass="p-0! text-xl!"
                    (click)="clearFilter(filterConfig.filter, filterConfig)"
                    [pTooltip]="'actions.clear' | translate"
                    tooltipPosition="top"
                  />
                }
              </div>

              <!-- Listbox del filtro -->
              <p-listbox
                [id]="'filter-' + filterConfig.filter"
                [options]="getDataSource(filterConfig.filter)"
                [optionLabel]="getFieldConfig(filterConfig).label"
                [optionValue]="getFieldConfig(filterConfig).id"
                [formControlName]="filterConfig.filter"
                [multiple]="filterConfig.multiple || false"
                [checkbox]="filterConfig.multiple || false"
                [filter]="filterConfig.searchable || false"
                [filterPlaceHolder]="filterConfig.placeholder || ('actions.search' | translate)"
                [class.single-selection]="!filterConfig.multiple"
                class="min-w-60"
                [highlightOnSelect]="false"
                fluid="true"
                [listStyle]="{ 'max-height': '250px' }"
              />

              <!-- Tooltip opcional -->
              @if (filterConfig.tooltip) {
                <small class="text-muted-color text-xs mt-1">
                  {{ filterConfig.tooltip | translate }}
                </small>
              }
            </div>
          }
        </div>
      </form>
    </div>

    <!-- Botones de acciÃ³n -->
    <div class="grid grid-cols-2 md:flex md:justify-end gap-2 mt-6">
      <p-button
        [label]="'actions.cancel' | translate"
        [outlined]="true"
        severity="secondary"
        (click)="onCancel(popover)"
        styleClass="w-full md:w-auto!"
      />
      <p-button
        [label]="'actions.accept' | translate"
        severity="primary"
        (click)="onAccept(popover)"
        styleClass="w-full md:w-auto!"
      />
    </div>
  </div>
</p-popover>
